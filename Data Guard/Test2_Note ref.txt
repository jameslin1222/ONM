Note ref:
Primary是 grid + ASM
Standby是 stand + file system (/u02/oradata/<SID>)
==========================
1. Primary:

先查相關參數:
[oracle@db19c01grid ~]$ sqlplus / as sysdba
SQL> show parameter db_name
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_name                              string      jamesdb
SQL> show parameter unique
NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_unique_name                       string      JAMESDB
SQL>



1.1 listener.ora (at "grid" 注意 SID名稱和GLOBAL_DBNAME 一定要注意)
$ vi /u01/app/19.0.0/grid/network/admin/listener.ora
~~~~~
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = jamesdb_DGMGRL)
      (ORACLE_HOME = /u01/app/oracle/product/19.0.0/dbhome_1)
      (SID_NAME = jamesdb)
      (ENVS="TNS_ADMIN=/u01/app/oracle/product/19.0.0/dbhome_1/network/admin")
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle

~~~~~

$ lsnrctl stop
$ lsnrctl start



1.2 tnsnames.ora (at "DBHOME" ,注意用 SID 比保險)
$ vi /u01/app/oracle/product/19.0.0/dbhome_1/network/admin/tnsnames.ora
~~~
JAMESDB =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.29)(PORT = 1521))
    (CONNECT_DATA =
      (SERVICE_NAME = JAMESDB)
      (SERVER = DEDICATED)
    )
  )


JAMESDB_STBY =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.20)(PORT = 1521))
    (CONNECT_DATA =
      (SID = JAMESDB)
      (SERVER = DEDICATED)
    )
  )

~~~~

1.3 orapwd 產生 並且複製到standby
$ orapwd file='$ORACLE_HOME/dbs/orapwjamesdb' password=P_ssword123 entries=10
$ scp $ORACLE_HOME/dbs/orapwjamesdb oracle@192.168.56.20:/tmp



1.4 查看對應的data files、redo files
SQL> SELECT file_name FROM dba_data_files;
SQL> SELECT member FROM v$logfile;

~
SQL> SELECT * FROM v$log;
SQL> SELECT * FROM v$standby_log;
SQL> SELECT parallel FROM v$instance;   -- 看PAR是不是NO
SQL> SELECT database_role, db_unique_name FROM v$database;





==========================
2. Standby:
2.1 設置基本的 init.ora (注意db_name和 db_unique_name)
[oracle@db19c02 ~]$ cat /tmp/initjamesdb_stby.ora
*.db_name='jamesdb'
*.db_unique_name='JAMESDB_STBY'

[oracle@db19c02 ~]$ mkdir -p /u02/oradata/JAMESDB
[oracle@db19c02 ~]$ mkdir -p /u02/fra



2.2 注意 listener.ora (最好用SID)
$ vi /u01/app/oracle/product/19.0.0/dbhome_1/network/admin/listener.ora
~~~~~~
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = db19c02)(PORT = 1521))
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
    )
  )

ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON              # line added by Agent
VALID_NODE_CHECKING_REGISTRATION_LISTENER=ON            # line added by Agent

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = JAMESDB_STBY_DGMGR)
      (SID_NAME = jamesdb)
      (ORACLE_HOME = /u01/app/oracle/product/19.0.0/dbhome_1)
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle

~~~~~~
$ lsnrctl stop
$ lsnrctl start



2.3 注意 tnsnames.ora (最好用SID)
$ vi /u01/app/oracle/product/19.0.0/dbhome_1/network/admin/tnsnames.ora
~~~~~~
PDB1 =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.20)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = PDB1)
    )
  )

JAMESDB =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.29)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = JAMESDB)
    )
  )

JAMESDB_STBY =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.56.20)(PORT = 1521))
    (CONNECT_DATA =
      (SID = JAMESDB)
      (SERVER = DEDICATED)
    )
  )
~~~~~~


2.4 pwd檔案複製到 dbs
$ cp /tmp/orapwjamesdb $ORACLE_HOME/dbs



==============================
## 3. Standby 開始運行 (目前問題還沒解決: ASM 跟 file system的轉換問題還沒做完)
STARTUP NOMOUNT PFILE='/tmp/initjamesdb_stby.ora';  

-- 以上做的如果順利才有以下能順利連接
rman target sys/P_ssword123@jamesdb AUXILIARY sys/P_ssword123@jamesdb_stby


DUPLICATE TARGET DATABASE
  FOR STANDBY
  FROM ACTIVE DATABASE
  DORECOVER
  SPFILE
    SET db_unique_name='JAMESDB_STBY' COMMENT 'Is standby'
  NOFILENAMECHECK;



XXXXXX 錯誤訊息 XXXXXXXXXXXXXXXXXXXXXXXXXX
connected to auxiliary database (not started)
Oracle instance started

Total System Global Area    4949277256 bytes

Fixed Size                     9144904 bytes
Variable Size                889192448 bytes
Database Buffers            4043309056 bytes
Redo Buffers                   7630848 bytes
duplicating Online logs to Oracle Managed File (OMF) location
duplicating Datafiles to Oracle Managed File (OMF) location
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of Duplicate Db command at 12/21/2025 23:56:15
RMAN-05501: aborting duplication of target database
RMAN-06136: Oracle error from auxiliary database: ORA-00200: control file could not be created
ORA-00202: control file: '+DATA'
ORA-17502: ksfdcre:4 Failed to create file +DATA
ORA-15001: diskgroup "DATA" does not exist or is not mounted
ORA-15374: invalid cluster configuration

RMAN>


XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
### 後來修正調整如下:

DUPLICATE TARGET DATABASE
  FOR STANDBY
  FROM ACTIVE DATABASE
  DORECOVER
  SPFILE
    SET db_unique_name='JAMESDB_STBY' COMMENT 'Is standby'
    SET db_create_file_dest='/u02/oradata/JAMESDB'
    SET control_files='/u02/oradata/JAMESDB/control01.ctl'
    SET db_recovery_file_dest='/u02/oradata/JAMESDB'
    SET db_recovery_file_dest_size='50G'
  NOFILENAMECHECK;



===================================================
### 4. Primary 和 Standby 都檢查
show parameter db_unique_name;  -- 兩者一定不同，其他都一樣
show parameter log_archive_config;
show parameter log_archive_dest_1;
show parameter log_archive_dest_2;
show parameter remote_login_passwordfile;


### 5.Standby 啟動
SQL> startup mount; /* 應該不用做，因為已經mount */
SQL> alter database recover managed standby database disconnect from session;


### 6.Primary 和 standby 啟動  dg_broker_start (兩邊都要做)
SQL> ALTER SYSTEM SET dg_broker_start=TRUE SCOPE=BOTH;


### 7.Primary 設定啟動 DGMGRL (會有錯誤，要修正)
$ dgmgrl sys/P_ssword123@JAMESDB
DGMGRL> create configuration 'DGConfig' as primary database is JAMESDB connect identifier is JAMESDB;


XXXXXXXXX
DGMGRL> add database JAMESDB_STBY as connect identifier is JAMESDB_STBY maintained as physical;
Error: ORA-16698: member has a LOG_ARCHIVE_DEST_n parameter with SERVICE attribute set

Failed.
DGMGRL>
XXXXXXXXX
現在遇到的 ORA-16698 錯誤，意思是：
在 Data Guard Broker 建立組態時，偵測到你的資料庫參數裡有 LOG_ARCHIVE_DEST_n 使用了 SERVICE= 屬性。Broker 不允許這樣，因為它要自己管理 redo 傳送的目的地。
- 但當你要用 Broker (DGMGRL) 管理時，這些 SERVICE= 參數必須移除，交由 Broker 自動生成並管理。
解決方法
1. 移除或清空有 SERVICE= 的 LOG_ARCHIVE_DEST_n
在 主庫與備庫 都執行：


### 8.在 主庫與備庫 都執行： (停用,兩邊都要做)
SQL> ALTER SYSTEM SET log_archive_dest_2='' SCOPE=BOTH;


### 9. Primary繼續操作
$ dgmgrl sys/P_ssword123@JAMESDB
DGMGRL> add database JAMESDB_STBY as connect identifier is JAMESDB_STBY maintained as physical;
Database "jamesdb_stby" added
DGMGRL> enable configuration;
Enabled.
DGMGRL>


### 10. 最後強制重啟Standby，並且是pdb狀態為open read only，讓他成達到active data guard效果
[oracle@db19c02 ~]$ sqlplus / as sysdba
SQL> show pdbs

    CON_ID CON_NAME                       OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
         2 PDB$SEED                       MOUNTED
         3 PDB1                           MOUNTED
SQL> alter session set container=pdb1;

Session altered.

SQL> select * from apps.t1;
select * from apps.t1
                   *
ERROR at line 1:
ORA-01219: database or pluggable database not open: queries allowed on fixed
tables or views only

SQL> exit




$ sqlplus / as sysdba
SQL> shutdown immediate;
SQL> startup
SQL> show pdbs

    CON_ID CON_NAME                       OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
         2 PDB$SEED                       READ ONLY  NO
         3 PDB1                           MOUNTED
SQL> alter pluggable database pdb1 open read only;  /* 就是這個 */

Pluggable database altered.

SQL> show pdbs

    CON_ID CON_NAME                       OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
         2 PDB$SEED                       READ ONLY  NO
         3 PDB1                           READ ONLY  NO
SQL>



### 11.檢查 standby和 primary資料是否有同步
SQL> alter session set container=pdb1;

Session altered.

SQL> select * from apps.t1;

        ID
----------
       100
       200
       333

SQL>


[oracle@db19c01grid ~]$ sqlplus apps/apps@pdb1
SQL> select * from t1;

        ID
----------
       100
       200
       333

SQL> insert into t1 values(999);
1 row created.
SQL> commit;
Commit complete.


(from standby)
SQL> select * from apps.t1;

        ID
----------
       100
       999
       200
       333

SQL>
